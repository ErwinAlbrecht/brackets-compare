define(function (require, exports, module) {
  "use strict";

  var AppInit = brackets.getModule("utils/AppInit");
  var WorkspaceManager = brackets.getModule("view/WorkspaceManager");
  var EditorManager = brackets.getModule("editor/EditorManager");
  var MainViewManager = brackets.getModule("view/MainViewManager");
  var Sidebar = brackets.getModule("project/SidebarView");
  var DocumentManager = brackets.getModule("document/DocumentManager");
  var ExtensionUtils = brackets.getModule("utils/ExtensionUtils");
  var ThemeManager = brackets.getModule("view/ThemeManager");

  var CodeMirror = brackets.getModule("thirdparty/CodeMirror2/lib/codemirror");

  var Logger = require("dist/logger");
  var Notifier = require("dist/notifier");

  var compareMode = false;
  var hdiff = 0;
  var editorCurrentHeight = 0;
  var notifier = new Notifier();

  var modes = {
    js: "javascript",
    css: "text/css",
    less: "text/css",
    sass: "text/css",
    coffee: "javascript",
    jsx: "javascript",
    json: "javascript",
    //'html': 'text/html',
    html: "htmlmixed"
  };

  function addToolbarButton(id, handler) {
    var html = "<a href=\"#\" title=\"Show diffs\" id=\"" + id + "\"> <i class=\"glyphicon glyphicon-duplicate\"></i></a>";
    $("#main-toolbar .buttons").append(html);
    $("#" + id).on("click", handler);
  }

  function changeButtonState(el, state) {
    if (state) {
      $("#compare-files").attr("title", "Hide diffs");
      $("#compare-files i").addClass("compare-active");
    } else {
      $("#compare-files").attr("title", "Show diffs");
      $("#compare-files i").removeClass("compare-active");
    }
  }

  function switchCompareMode() {
    var switchListener = arguments[0] === undefined ? null : arguments[0];

    compareMode = !compareMode;
    if (typeof switchListener === "function") {
      switchListener(compareMode);
    }
  }

  function onWorkspaceLayoutUpdate(o, x, y) {
    var cdiff = $("#compare-pane").parent().height() - hdiff;
    $("#compare-pane").css("height", cdiff + "px");
  }

  function getExtension(filename) {
    var regExp = /\.(\w+)$/;
    return String(filename).match(regExp)[1];
  }

  AppInit.appReady(function () {
    var COMPARE_PANEL_HTML = "<div id=\"compare-pane\">" + "<div class=\"pane-header\">" + "<div id=\"pane-left\" class=\"pane-header-content pane-left\"></div>" + "<div id=\"pane-right\" class=\"pane-header-content pane-right\" ></div>" + "</div>" + "<div class=\"pane-content\"></div>" + "</div>";
    var comparePanel = null;
    var compareView = null;

    var currentTheme = ThemeManager.getCurrentTheme();

    addToolbarButton("compare-files", function (e) {
      // make sure there are aleast two panes to compare
      var panes = MainViewManager.getPaneIdList();
      var target = document.querySelector("#compare-pane .pane-content");
      var editor = $("#editor-holder");
      editorCurrentHeight = $("#editor-holder").height();

      // Both panes should be selected
      if (panes.length < 2) {
        notifier.error("Cannot compare only one view / file selected. To select two files to compare, use the split views.");
        Logger.error("Cannot compare only one view / file selected. To select two files to compare, use the split views.");
        return;
      }

      var mFile = MainViewManager.getCurrentlyViewedFile(panes[0]);
      var oFile = MainViewManager.getCurrentlyViewedFile(panes[1]);

      if (mFile === null || oFile === null) {
        notifier.error("No file selected for one or all of the views. Please select a file / files.");
        Logger.error("No file selected for one or all of the views. Please select a file / files.");
        return;
      }

      if (getExtension(mFile._name) !== getExtension(oFile._name)) {
        notifier.error("Cannot compare files of different types. Please select files of the same type.");
        Logger.error("Cannot compare files of different types. Please select files of the same type.");
        return;
      }

      var fileExt = getExtension(mFile._name);

      switchCompareMode(function (cmode) {
        changeButtonState(e.target || e.currentTarget, cmode);

        if (cmode) {
          comparePanel.show();
          compareView = CodeMirror.MergeView(target, {
            value: mFile._contents,
            orig: oFile._contents,
            hightlightDifferences: false,
            collapseIdentical: false,
            options: {
              allowEditingOriginals: true
            },
            lineNumbers: true,
            theme: currentTheme.name,
            mode: modes[fileExt]
          });

          WorkspaceManager.on(WorkspaceManager.EVENT_WORKSPACE_UPDATE_LAYOUT, onWorkspaceLayoutUpdate);
          editor.addClass("hide");
          Sidebar.hide();

          $("#pane-left").html(mFile._parentPath + "<span class=\"file-name\">" + mFile._name + "</span>");
          $("#pane-right").html("<span class=\"perm\">[read-only]</span> " + oFile._parentPath + "<span class=\"file-name\">" + oFile._name + "</span>");

          var compareEditor = $("#compare-pane");
          // Calculate the height diff

          compareEditor.css("height", editorCurrentHeight + "px");
          hdiff = compareEditor.parent().height() - editorCurrentHeight;
        } else {
          comparePanel.hide();
          target.innerHTML = "";
          compareView = null;
          editor.removeClass("hide");
          WorkspaceManager.off(WorkspaceManager.EVENT_WORKSPACE_UPDATE_LAYOUT, onWorkspaceLayoutUpdate);
          Sidebar.show();
        }
      });
    });

    // Create a new panel to hold the diff views
    comparePanel = WorkspaceManager.createBottomPanel("compare.panel", $(COMPARE_PANEL_HTML), 1000);
  });
});
//# sourceMappingURL=data:application/json;base64,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QVcsR0FBRyxJQUFJLENBQUM7QUFDbkIsZ0JBQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsMEJBQWdCLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLDZCQUE2QixFQUFFLHVCQUF1QixDQUFDLENBQUM7QUFDOUYsaUJBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNoQjtPQUNGLENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQzs7O0FBR0gsZ0JBQVksR0FBRyxnQkFBZ0IsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7R0FDakcsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6Im1haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJkZWZpbmUoZnVuY3Rpb24gKHJlcXVpcmUsIGV4cG9ydHMsIG1vZHVsZSkge1xuICBcInVzZSBzdHJpY3RcIjtcblxuICBsZXQgQXBwSW5pdCA9IGJyYWNrZXRzLmdldE1vZHVsZShcInV0aWxzL0FwcEluaXRcIik7XG4gIGxldCBXb3Jrc3BhY2VNYW5hZ2VyID0gYnJhY2tldHMuZ2V0TW9kdWxlKFwidmlldy9Xb3Jrc3BhY2VNYW5hZ2VyXCIpO1xuICBsZXQgRWRpdG9yTWFuYWdlciA9IGJyYWNrZXRzLmdldE1vZHVsZShcImVkaXRvci9FZGl0b3JNYW5hZ2VyXCIpO1xuICBsZXQgTWFpblZpZXdNYW5hZ2VyID0gYnJhY2tldHMuZ2V0TW9kdWxlKFwidmlldy9NYWluVmlld01hbmFnZXJcIik7XG4gIGxldCBTaWRlYmFyID0gYnJhY2tldHMuZ2V0TW9kdWxlKFwicHJvamVjdC9TaWRlYmFyVmlld1wiKTtcbiAgbGV0IERvY3VtZW50TWFuYWdlciA9IGJyYWNrZXRzLmdldE1vZHVsZShcImRvY3VtZW50L0RvY3VtZW50TWFuYWdlclwiKTtcbiAgbGV0IEV4dGVuc2lvblV0aWxzID0gYnJhY2tldHMuZ2V0TW9kdWxlKFwidXRpbHMvRXh0ZW5zaW9uVXRpbHNcIik7XG4gIGxldCBUaGVtZU1hbmFnZXIgPSBicmFja2V0cy5nZXRNb2R1bGUoXCJ2aWV3L1RoZW1lTWFuYWdlclwiKTtcblxuICBsZXQgQ29kZU1pcnJvciA9IGJyYWNrZXRzLmdldE1vZHVsZShcInRoaXJkcGFydHkvQ29kZU1pcnJvcjIvbGliL2NvZGVtaXJyb3JcIik7XG5cbiAgbGV0IExvZ2dlciA9IHJlcXVpcmUoXCJkaXN0L2xvZ2dlclwiKTtcbiAgbGV0IE5vdGlmaWVyID0gcmVxdWlyZSgnZGlzdC9ub3RpZmllcicpO1xuXG4gIGxldCBjb21wYXJlTW9kZSA9IGZhbHNlO1xuICBsZXQgaGRpZmYgPSAwO1xuICBsZXQgZWRpdG9yQ3VycmVudEhlaWdodCA9IDA7XG4gIGxldCBub3RpZmllciA9IG5ldyBOb3RpZmllcigpO1xuICBcbiAgY29uc3QgbW9kZXMgPSB7XG4gICAgJ2pzJzogJ2phdmFzY3JpcHQnLFxuICAgICdjc3MnOiAndGV4dC9jc3MnLFxuICAgICdsZXNzJzogJ3RleHQvY3NzJyxcbiAgICAnc2Fzcyc6ICd0ZXh0L2NzcycsXG4gICAgJ2NvZmZlZSc6ICdqYXZhc2NyaXB0JyxcbiAgICAnanN4JzogJ2phdmFzY3JpcHQnLFxuICAgICdqc29uJzogJ2phdmFzY3JpcHQnLFxuICAgIC8vJ2h0bWwnOiAndGV4dC9odG1sJyxcbiAgICAnaHRtbCc6ICdodG1sbWl4ZWQnXG4gIH07XG5cbiAgZnVuY3Rpb24gYWRkVG9vbGJhckJ1dHRvbihpZCwgaGFuZGxlcikge1xuICAgIHZhciBodG1sID0gXCI8YSBocmVmPVxcXCIjXFxcIiB0aXRsZT1cXFwiU2hvdyBkaWZmc1xcXCIgaWQ9XFxcIlwiICsgaWQgKyBcIlxcXCI+IDxpIGNsYXNzPVxcXCJnbHlwaGljb24gZ2x5cGhpY29uLWR1cGxpY2F0ZVxcXCI+PC9pPjwvYT5cIjtcbiAgICAkKFwiI21haW4tdG9vbGJhciAuYnV0dG9uc1wiKS5hcHBlbmQoaHRtbCk7XG4gICAgJChcIiNcIiArIGlkKS5vbihcImNsaWNrXCIsIGhhbmRsZXIpO1xuICB9XG5cbiAgZnVuY3Rpb24gY2hhbmdlQnV0dG9uU3RhdGUoZWwsIHN0YXRlKSB7XG4gICAgaWYgKHN0YXRlKSB7XG4gICAgICAkKFwiI2NvbXBhcmUtZmlsZXNcIikuYXR0cihcInRpdGxlXCIsIFwiSGlkZSBkaWZmc1wiKTtcbiAgICAgICQoXCIjY29tcGFyZS1maWxlcyBpXCIpLmFkZENsYXNzKFwiY29tcGFyZS1hY3RpdmVcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgICQoXCIjY29tcGFyZS1maWxlc1wiKS5hdHRyKFwidGl0bGVcIiwgXCJTaG93IGRpZmZzXCIpO1xuICAgICAgJChcIiNjb21wYXJlLWZpbGVzIGlcIikucmVtb3ZlQ2xhc3MoXCJjb21wYXJlLWFjdGl2ZVwiKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBzd2l0Y2hDb21wYXJlTW9kZSgpIHtcbiAgICB2YXIgc3dpdGNoTGlzdGVuZXIgPSBhcmd1bWVudHNbMF0gPT09IHVuZGVmaW5lZCA/IG51bGwgOiBhcmd1bWVudHNbMF07XG5cbiAgICBjb21wYXJlTW9kZSA9ICFjb21wYXJlTW9kZTtcbiAgICBpZiAodHlwZW9mIHN3aXRjaExpc3RlbmVyID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHN3aXRjaExpc3RlbmVyKGNvbXBhcmVNb2RlKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBvbldvcmtzcGFjZUxheW91dFVwZGF0ZShvLCB4LCB5KSB7XG4gICAgdmFyIGNkaWZmID0gJChcIiNjb21wYXJlLXBhbmVcIikucGFyZW50KCkuaGVpZ2h0KCkgLSBoZGlmZjtcbiAgICAkKFwiI2NvbXBhcmUtcGFuZVwiKS5jc3MoXCJoZWlnaHRcIiwgY2RpZmYgKyBcInB4XCIpO1xuICB9XG4gIFxuICBmdW5jdGlvbiBnZXRFeHRlbnNpb24oZmlsZW5hbWUpIHtcbiAgICB2YXIgcmVnRXhwID0gL1xcLihcXHcrKSQvO1xuICAgIHJldHVybiBTdHJpbmcoZmlsZW5hbWUpLm1hdGNoKHJlZ0V4cClbMV07XG4gIH1cbiAgXG4gIFxuICBBcHBJbml0LmFwcFJlYWR5KGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgQ09NUEFSRV9QQU5FTF9IVE1MID0gXCI8ZGl2IGlkPVxcXCJjb21wYXJlLXBhbmVcXFwiPlwiICsgXCI8ZGl2IGNsYXNzPVxcXCJwYW5lLWhlYWRlclxcXCI+XCIgKyBcIjxkaXYgaWQ9XFxcInBhbmUtbGVmdFxcXCIgY2xhc3M9XFxcInBhbmUtaGVhZGVyLWNvbnRlbnQgcGFuZS1sZWZ0XFxcIj48L2Rpdj5cIiArIFwiPGRpdiBpZD1cXFwicGFuZS1yaWdodFxcXCIgY2xhc3M9XFxcInBhbmUtaGVhZGVyLWNvbnRlbnQgcGFuZS1yaWdodFxcXCIgPjwvZGl2PlwiICsgXCI8L2Rpdj5cIiArIFwiPGRpdiBjbGFzcz1cXFwicGFuZS1jb250ZW50XFxcIj48L2Rpdj5cIiArIFwiPC9kaXY+XCI7XG4gICAgdmFyIGNvbXBhcmVQYW5lbCA9IG51bGw7XG4gICAgdmFyIGNvbXBhcmVWaWV3ID0gbnVsbDtcblxuICAgIHZhciBjdXJyZW50VGhlbWUgPSBUaGVtZU1hbmFnZXIuZ2V0Q3VycmVudFRoZW1lKCk7XG4gICAgXG4gICAgXG5cbiAgICBhZGRUb29sYmFyQnV0dG9uKFwiY29tcGFyZS1maWxlc1wiLCBmdW5jdGlvbiAoZSkge1xuICAgICAgLy8gbWFrZSBzdXJlIHRoZXJlIGFyZSBhbGVhc3QgdHdvIHBhbmVzIHRvIGNvbXBhcmVcbiAgICAgIGxldCBwYW5lcyA9IE1haW5WaWV3TWFuYWdlci5nZXRQYW5lSWRMaXN0KCk7XG4gICAgICBsZXQgdGFyZ2V0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIiNjb21wYXJlLXBhbmUgLnBhbmUtY29udGVudFwiKTtcbiAgICAgIGxldCBlZGl0b3IgPSAkKFwiI2VkaXRvci1ob2xkZXJcIik7XG4gICAgICBlZGl0b3JDdXJyZW50SGVpZ2h0ID0gJChcIiNlZGl0b3ItaG9sZGVyXCIpLmhlaWdodCgpO1xuXG4gICAgICAvLyBCb3RoIHBhbmVzIHNob3VsZCBiZSBzZWxlY3RlZFxuICAgICAgaWYgKHBhbmVzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgbm90aWZpZXIuZXJyb3IoJ0Nhbm5vdCBjb21wYXJlIG9ubHkgb25lIHZpZXcgLyBmaWxlIHNlbGVjdGVkLiBUbyBzZWxlY3QgdHdvIGZpbGVzIHRvIGNvbXBhcmUsIHVzZSB0aGUgc3BsaXQgdmlld3MuJyk7XG4gICAgICAgIExvZ2dlci5lcnJvcignQ2Fubm90IGNvbXBhcmUgb25seSBvbmUgdmlldyAvIGZpbGUgc2VsZWN0ZWQuIFRvIHNlbGVjdCB0d28gZmlsZXMgdG8gY29tcGFyZSwgdXNlIHRoZSBzcGxpdCB2aWV3cy4nKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgXG4gICAgICBsZXQgbUZpbGUgPSBNYWluVmlld01hbmFnZXIuZ2V0Q3VycmVudGx5Vmlld2VkRmlsZShwYW5lc1swXSk7XG4gICAgICBsZXQgb0ZpbGUgPSBNYWluVmlld01hbmFnZXIuZ2V0Q3VycmVudGx5Vmlld2VkRmlsZShwYW5lc1sxXSk7XG4gICAgICBcbiAgICAgIGlmIChtRmlsZSA9PT0gbnVsbCB8fCBvRmlsZSA9PT0gbnVsbCkge1xuICAgICAgICBub3RpZmllci5lcnJvcignTm8gZmlsZSBzZWxlY3RlZCBmb3Igb25lIG9yIGFsbCBvZiB0aGUgdmlld3MuIFBsZWFzZSBzZWxlY3QgYSBmaWxlIC8gZmlsZXMuJyk7XG4gICAgICAgIExvZ2dlci5lcnJvcignTm8gZmlsZSBzZWxlY3RlZCBmb3Igb25lIG9yIGFsbCBvZiB0aGUgdmlld3MuIFBsZWFzZSBzZWxlY3QgYSBmaWxlIC8gZmlsZXMuJyk7XG4gICAgICAgIHJldHVybjsgXG4gICAgICB9XG4gICAgICBcbiAgICAgIGlmIChnZXRFeHRlbnNpb24obUZpbGUuX25hbWUpICE9PSBnZXRFeHRlbnNpb24ob0ZpbGUuX25hbWUpKSB7XG4gICAgICAgIG5vdGlmaWVyLmVycm9yKCdDYW5ub3QgY29tcGFyZSBmaWxlcyBvZiBkaWZmZXJlbnQgdHlwZXMuIFBsZWFzZSBzZWxlY3QgZmlsZXMgb2YgdGhlIHNhbWUgdHlwZS4nKTtcbiAgICAgICAgTG9nZ2VyLmVycm9yKCdDYW5ub3QgY29tcGFyZSBmaWxlcyBvZiBkaWZmZXJlbnQgdHlwZXMuIFBsZWFzZSBzZWxlY3QgZmlsZXMgb2YgdGhlIHNhbWUgdHlwZS4nKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgXG4gICAgICBsZXQgZmlsZUV4dCA9IGdldEV4dGVuc2lvbihtRmlsZS5fbmFtZSk7XG5cbiAgICAgIHN3aXRjaENvbXBhcmVNb2RlKGZ1bmN0aW9uIChjbW9kZSkge1xuICAgICAgICBjaGFuZ2VCdXR0b25TdGF0ZShlLnRhcmdldCB8fCBlLmN1cnJlbnRUYXJnZXQsIGNtb2RlKTtcblxuICAgICAgICBpZiAoY21vZGUpIHtcbiAgICAgICAgICBjb21wYXJlUGFuZWwuc2hvdygpO1xuICAgICAgICAgIGNvbXBhcmVWaWV3ID0gQ29kZU1pcnJvci5NZXJnZVZpZXcodGFyZ2V0LCB7XG4gICAgICAgICAgICB2YWx1ZTogbUZpbGUuX2NvbnRlbnRzLFxuICAgICAgICAgICAgb3JpZzogb0ZpbGUuX2NvbnRlbnRzLFxuICAgICAgICAgICAgaGlnaHRsaWdodERpZmZlcmVuY2VzOiBmYWxzZSxcbiAgICAgICAgICAgIGNvbGxhcHNlSWRlbnRpY2FsOiBmYWxzZSxcbiAgICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgYWxsb3dFZGl0aW5nT3JpZ2luYWxzOiB0cnVlIFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGxpbmVOdW1iZXJzOiB0cnVlLFxuICAgICAgICAgICAgdGhlbWU6IGN1cnJlbnRUaGVtZS5uYW1lLFxuICAgICAgICAgICAgbW9kZTogbW9kZXNbZmlsZUV4dF1cbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIFdvcmtzcGFjZU1hbmFnZXIub24oV29ya3NwYWNlTWFuYWdlci5FVkVOVF9XT1JLU1BBQ0VfVVBEQVRFX0xBWU9VVCwgb25Xb3Jrc3BhY2VMYXlvdXRVcGRhdGUpO1xuICAgICAgICAgIGVkaXRvci5hZGRDbGFzcyhcImhpZGVcIik7XG4gICAgICAgICAgU2lkZWJhci5oaWRlKCk7XG5cbiAgICAgICAgICAkKFwiI3BhbmUtbGVmdFwiKS5odG1sKG1GaWxlLl9wYXJlbnRQYXRoICsgJzxzcGFuIGNsYXNzPVxcXCJmaWxlLW5hbWVcXFwiPicgKyBtRmlsZS5fbmFtZSArICc8L3NwYW4+Jyk7XG4gICAgICAgICAgJChcIiNwYW5lLXJpZ2h0XCIpLmh0bWwoXCI8c3BhbiBjbGFzcz1cXFwicGVybVxcXCI+W3JlYWQtb25seV08L3NwYW4+IFwiICsgb0ZpbGUuX3BhcmVudFBhdGggKyAnPHNwYW4gY2xhc3M9XFxcImZpbGUtbmFtZVxcXCI+JyArIG9GaWxlLl9uYW1lICsgJzwvc3Bhbj4nKTtcblxuICAgICAgICAgIHZhciBjb21wYXJlRWRpdG9yID0gJChcIiNjb21wYXJlLXBhbmVcIik7XG4gICAgICAgICAgLy8gQ2FsY3VsYXRlIHRoZSBoZWlnaHQgZGlmZlxuXG4gICAgICAgICAgY29tcGFyZUVkaXRvci5jc3MoXCJoZWlnaHRcIiwgZWRpdG9yQ3VycmVudEhlaWdodCArIFwicHhcIik7XG4gICAgICAgICAgaGRpZmYgPSBjb21wYXJlRWRpdG9yLnBhcmVudCgpLmhlaWdodCgpIC0gZWRpdG9yQ3VycmVudEhlaWdodDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb21wYXJlUGFuZWwuaGlkZSgpO1xuICAgICAgICAgIHRhcmdldC5pbm5lckhUTUwgPSBcIlwiO1xuICAgICAgICAgIGNvbXBhcmVWaWV3ID0gbnVsbDtcbiAgICAgICAgICBlZGl0b3IucmVtb3ZlQ2xhc3MoXCJoaWRlXCIpO1xuICAgICAgICAgIFdvcmtzcGFjZU1hbmFnZXIub2ZmKFdvcmtzcGFjZU1hbmFnZXIuRVZFTlRfV09SS1NQQUNFX1VQREFURV9MQVlPVVQsIG9uV29ya3NwYWNlTGF5b3V0VXBkYXRlKTtcbiAgICAgICAgICBTaWRlYmFyLnNob3coKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgYSBuZXcgcGFuZWwgdG8gaG9sZCB0aGUgZGlmZiB2aWV3c1xuICAgIGNvbXBhcmVQYW5lbCA9IFdvcmtzcGFjZU1hbmFnZXIuY3JlYXRlQm90dG9tUGFuZWwoXCJjb21wYXJlLnBhbmVsXCIsICQoQ09NUEFSRV9QQU5FTF9IVE1MKSwgMTAwMCk7XG4gIH0pO1xufSk7Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
